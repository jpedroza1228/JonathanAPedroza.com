{
  "hash": "5423b8a586a4903e95e76af2d52a2073",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Using a Bayesian Network For Machine Learning\" \n# subtitle: |\n  # text\n#image: \ncategories: [bayes-net, bayesian network, machine learning, R]\ndate: 2024-11-11\nexecute:\n  warning: false\n  message: false\nparams:\n  slug: bayes-net-machine-learning\n  date: 2024-11-11\n---\n\n\nFor this tutorial, I wanted to create a more interesting and maybe more realistic use of a Bayesian Network (bayes net). That is why I am walking through how to use a bayes net in a machine learning application while also seeing what the likelihood of getting a loan approved would be based off some Kaggle data (data can be found [here](https://www.kaggle.com/datasets/taweilo/loan-approval-classification-data)). First, I'll load in the packages I'll need and the data. \n\n# Loading Data In\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(inspectdf)\nlibrary(bnlearn)\nlibrary(Rgraphviz)\nlibrary(reactable)\n\ntheme_set(theme_light())\n\nbn_score <- bnlearn::score\n\noptions(scipen = 9999)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nloan <- read_csv(\n  here::here(\n    \"posts/2024-11-08-bayes-net-loan-approval\",\n    \"loan_data.csv\"\n  )\n  )\n\n# loan |> glimpse()\n```\n:::\n\n\n# Exploring Data\n\nFor some exploratory data analysis, I wanted to look at variables with correlations that indicate multicollinearity so I could remove any variables that would add redundance to my bayes net model. The first was to see any variable that was correlated with the length of credit history in years (`cb_person_cred_hist_length`). Due to the high correlation between this variable and someone's age (`person_age`) and years of employment experience (`person_emp_exp`), I decided to remove `cb_person_cred_hist_length` and `person_emp_exp` and only kept age. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nloan |>\n  inspect_cor(\n    with = \"cb_person_cred_hist_length\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 7\n  col_1                      col_2     corr   p_value    lower    upper pcnt_nna\n  <chr>                      <chr>    <dbl>     <dbl>    <dbl>    <dbl>    <dbl>\n1 cb_person_cred_hist_length perso…  0.862  0          0.860    0.864        100\n2 cb_person_cred_hist_length perso…  0.824  0          0.821    0.827        100\n3 cb_person_cred_hist_length credi…  0.155  1.04e-237  0.146    0.164        100\n4 cb_person_cred_hist_length perso…  0.124  2.99e-153  0.115    0.133        100\n5 cb_person_cred_hist_length loan_…  0.0430 7.88e- 20  0.0337   0.0522       100\n6 cb_person_cred_hist_length loan_… -0.0319 1.38e- 11 -0.0411  -0.0226       100\n7 cb_person_cred_hist_length loan_…  0.0180 1.33e-  4  0.00877  0.0272       100\n8 cb_person_cred_hist_length loan_… -0.0149 1.63e-  3 -0.0241  -0.00561      100\n```\n\n\n:::\n\n```{.r .cell-code}\nloan |>\n  inspect_cor(\n    with = \"person_age\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 7\n  col_1      col_2                       corr  p_value    lower   upper pcnt_nna\n  <chr>      <chr>                      <dbl>    <dbl>    <dbl>   <dbl>    <dbl>\n1 person_age person_emp_exp            0.954  0         0.954    0.955       100\n2 person_age cb_person_cred_hist_len…  0.862  0         0.860    0.864       100\n3 person_age person_income             0.194  0         0.185    0.203       100\n4 person_age credit_score              0.178  0         0.169    0.187       100\n5 person_age loan_amnt                 0.0507 5.02e-27  0.0415   0.0600      100\n6 person_age loan_percent_income      -0.0433 4.13e-20 -0.0525  -0.0341      100\n7 person_age loan_status              -0.0215 5.22e- 6 -0.0307  -0.0122      100\n8 person_age loan_int_rate             0.0134 4.47e- 3  0.00416  0.0226      100\n```\n\n\n:::\n:::\n\n\nI also decided to check on the loan amount to see if there were any variables correlated with the `loan_amnt` variable. While the loan amount as a percentage of annual income (`loan_percent_income`) had a high correlation, I decided to keep it in the bayes net model. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nloan |>\n  inspect_cor(\n    with = \"loan_amnt\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 7\n  col_1     col_2                        corr   p_value    lower  upper pcnt_nna\n  <chr>     <chr>                       <dbl>     <dbl>    <dbl>  <dbl>    <dbl>\n1 loan_amnt loan_percent_income       0.593   0          5.87e-1 0.599       100\n2 loan_amnt person_income             0.242   0          2.34e-1 0.251       100\n3 loan_amnt loan_int_rate             0.146   7.35e-211  1.37e-1 0.155       100\n4 loan_amnt loan_status               0.108   1.50e-115  9.86e-2 0.117       100\n5 loan_amnt person_age                0.0507  5.02e- 27  4.15e-2 0.0600      100\n6 loan_amnt person_emp_exp            0.0446  3.12e- 21  3.54e-2 0.0538      100\n7 loan_amnt cb_person_cred_hist_leng… 0.0430  7.88e- 20  3.37e-2 0.0522      100\n8 loan_amnt credit_score              0.00907 5.42e-  2 -1.65e-4 0.0183      100\n```\n\n\n:::\n:::\n\n\nThe last thing I did before going into building the model was recoding all of my variables to be categorical. I wanted to conduct a discrete bayes net rather than create a mixed data model so the coding below is how I changed all of my variables. I am only showing the final recoding of my variables because some of the variables were recoded to have decent proportions within each level. The proportion of cases for \"Other\" was extremely low at 0.0026 so I decided to drop the \"Other\" level.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloan_cat <- loan |> \n  mutate(\n    credit_score_brack = case_when(\n      credit_score > 800 ~ \"excellent\",\n      credit_score < 800 & credit_score >= 740 ~ \"very_good\",\n      credit_score < 740 & credit_score >= 670 ~ \"good\",\n      credit_score < 670 & credit_score >= 580 ~ \"fair\",\n      credit_score < 580 ~ \"poor\"\n    ),\n    cred_hist_length_brack = case_when(\n      cb_person_cred_hist_length >= 18 ~ \"18+\",\n      TRUE ~ as.character(cb_person_cred_hist_length)\n    ),\n    loan_percent_income_brack = case_when(\n      loan_percent_income >= .3 ~ \".3+\",\n      loan_percent_income < .3 & loan_percent_income >= .2 ~ \".2 - .29\",\n      loan_percent_income < .2 & loan_percent_income >= .1 ~ \".1 - .19\",\n      loan_percent_income < .1 ~ \"0-.09\"\n    ),\n    loan_int_rate_brack = case_when(\n      loan_int_rate < 10 ~ \"<10\",\n      loan_int_rate >= 10 & loan_int_rate <= 15 ~ \"10 - 15\",\n      loan_int_rate > 15 ~ \"15+\"\n    ),\n    loan_amnt_brack = case_when(\n      loan_amnt < 5000 ~ \"<5k\",\n      loan_amnt >= 5000 & loan_amnt <= 9999 ~ \"5k - 9.99k\",\n      loan_amnt >= 10000 & loan_amnt <= 15000 ~ \"10k - 14.99k\",\n      loan_amnt >= 15000 & loan_amnt <= 20000 ~ \"15k - 19.99k\",\n      loan_amnt >= 20000 ~ \"20k+\"\n    ),\n    # person_emp_exp_brack = case_when(\n    #   person_emp_exp > 50 ~ NA_character_,\n    #   person_emp_exp >= 20 & person_emp_exp <= 50 ~ \"20 - 50 years\",\n    #   person_emp_exp >= 10 & person_emp_exp < 20 ~ \"10 - 19 years\",\n    #   person_emp_exp >= 5 & person_emp_exp < 10 ~ \"5 - 9 years\",\n    #   person_emp_exp < 5 ~ \"<5 years\"\n    # ),\n    person_income_brack = case_when(\n      person_income < 30000 ~ \"<30k\",\n      person_income >= 30000 & person_income < 50000 ~ \"30k - 49,999\",\n      person_income >= 50000 & person_income < 70000 ~ \"50k - 69,999\",\n      person_income >= 70000 & person_income < 90000 ~ \"70k - 89,999\",\n      person_income >= 90000  ~ \"90k\"\n    ),\n    person_age_brack = case_when(\n      person_age < 30 ~ \"<30\",\n      person_age >= 30 & person_age < 40 ~ \"30-39\",\n      person_age >= 40  ~ \"40+\"\n    )\n  ) |>\n  drop_na(\n    person_age_brack\n  ) |>\n  filter(\n    person_home_ownership != \"OTHER\"\n  ) |>\n  select(\n    matches(      \n      \"_brack$\"\n    ),\n    person_gender,\n    person_education,\n    person_home_ownership,\n    loan_intent,\n    previous_loan_defaults_on_file,\n    loan_status\n  )\n```\n:::\n\n\nHere is the code I kept checking to double check the recoding of variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap(\n  loan_cat,\n  ~round(prop.table(table(.x)), 2)\n)\n```\n:::\n\n\nBecause, I'm a visual learner I also decided to include these visualizations to show the counts for each level for each variable. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap2(\n  loan_cat,\n  loan_cat |> colnames(),\n  ~loan_cat |>\n    ggplot(\n      aes(\n        .x\n      )\n    ) +\n    geom_bar(\n      color = \"black\",\n      fill = \"dodgerblue\"\n    ) +\n    labs(\n      title = glue::glue(\"{.y}\")\n    )\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$credit_score_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$cred_hist_length_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$loan_percent_income_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$loan_int_rate_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$loan_amnt_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-5.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$person_income_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-6.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$person_age_brack\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-7.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$person_gender\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-8.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$person_education\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-9.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$person_home_ownership\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-10.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$loan_intent\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-11.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$previous_loan_defaults_on_file\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-12.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n$loan_status\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-13.png){width=672}\n:::\n:::\n\n\nTo be able to create a discrete bayes net using the bnlearn package, every variable needs to be changed to a factor type and bnlearn does not like tibbles so I had to change the data back to a data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloan_fact <- loan_cat |>\n  mutate(\n    across(\n      everything(),\n      ~as.factor(.x)\n    )\n  )\n\nloan_fact <- as.data.frame(loan_fact)\n```\n:::\n\n\n# Bayes Net\n\nLet's start with separating our data into the training and testing sets. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nloan_train <- loan_fact |>\n  slice_sample(\n    prop = .75\n    )\n\nloan_test <- anti_join(\n  loan_fact,\n  loan_train\n)\n```\n:::\n\n\nFor my training and testing sets I also decided to rearrange my factors just to reorganize for any visualizations later. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nloan_train <- loan_train |>\n  select(\n    -cred_hist_length_brack\n  ) |>\n  mutate(\n    person_education = fct_relevel(\n      person_education,\n      \"High School\",\n      \"Associate\",\n      \"Bachelor\",\n      \"Master\",\n      \"Doctorate\"\n    ),\n    person_income_brack = fct_relevel(\n      person_income_brack,\n      \"<30k\",\n      \"30k - 49,999\",\n      \"50k - 69,999\",\n      \"70k - 89,999\",\n      \"90k\"\n    ),\n    # person_emp_exp_brack = fct_relevel(\n    #   person_emp_exp_brack,\n    #   \"<5 years\",\n    #   \"5 - 9 years\",\n    #   \"10 - 19 years\",\n    #   \"20 - 50 years\"\n    # ),\n    loan_amnt_brack = fct_relevel(\n      loan_amnt_brack,\n      \"<5k\",\n      \"5k - 9.99k\",\n      \"10k - 14.99k\",\n      \"15k - 19.99k\",\n      \"20k+\"\n    ),\n    loan_percent_income_brack = fct_relevel(\n      loan_percent_income_brack,\n      \"0-.09\",\n      \".1 - .19\",\n      \".2 - .29\",\n      \".3+\"\n    ),\n    credit_score_brack = fct_relevel(\n      credit_score_brack,\n      \"poor\",\n      \"fair\",\n      \"good\",\n      \"very_good\"\n    )\n  )\n\nloan_test <- loan_test |>\n  select(\n    -cred_hist_length_brack\n  ) |>\n  mutate(\n    person_education = fct_relevel(\n      person_education,\n      \"High School\",\n      \"Associate\",\n      \"Bachelor\",\n      \"Master\",\n      \"Doctorate\"\n    ),\n    person_income_brack = fct_relevel(\n      person_income_brack,\n      \"<30k\",\n      \"30k - 49,999\",\n      \"50k - 69,999\",\n      \"70k - 89,999\",\n      \"90k\"\n    ),\n    # person_emp_exp_brack = fct_relevel(\n    #   person_emp_exp_brack,\n    #   \"<5 years\",\n    #   \"5 - 9 years\",\n    #   \"10 - 19 years\",\n    #   \"20 - 50 years\"\n    # ),\n    loan_amnt_brack = fct_relevel(\n      loan_amnt_brack,\n      \"<5k\",\n      \"5k - 9.99k\",\n      \"10k - 14.99k\",\n      \"15k - 19.99k\",\n      \"20k+\"\n    ),\n    loan_percent_income_brack = fct_relevel(\n      loan_percent_income_brack,\n      \"0-.09\",\n      \".1 - .19\",\n      \".2 - .29\",\n      \".3+\"\n    ),\n    credit_score_brack = fct_relevel(\n      credit_score_brack,\n      \"poor\",\n      \"fair\",\n      \"good\",\n      \"very_good\"\n    )\n  )\n```\n:::\n\n\nI'm going to start all of my [directed acyclic graphs](https://en.wikipedia.org/wiki/Directed_acyclic_graph) from an empty DAG. The names for the other DAGs will make sense once we get to each structure learning alogirthms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndag <- empty.graph(colnames(loan_train))\n\nhc_dag <- dag\njp_dag <- dag\nmmhc_dag <- dag\niamb_dag <- dag\n```\n:::\n\n\n## Structure Learning\n\nWhile I'm not going to go into a lot of detail about it, structure learning is the process of learning the structure of the DAG from the data. For this example, I'll be using different algorithms for structure learning to see which algorithm has the best network score, including the log likelihood and the Bayesian Dirichlet Equivalent (BDE) score. There are two arguments for each of the learning algorithms, a blacklist and a whitelist, which are edges (relationships) between nodes (variables) that we either don't want the algorithm to make or want to make sure are included in the model respectively. Bnlearn has links to articles of interest for all of the structure learning algorithms [here if interested about how the algorithms work](https://www.bnlearn.com/documentation/man/structure.learning.html). \n\nI only included a blacklist and made sure that there were no edges from the outcome of interest (`loan_status`) as well as no edges that end at the demographic nodes of gender, age, and education.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbl <- matrix(\n  c(\n    \"loan_status\", \"person_gender\",\n    \"loan_status\", \"person_age_brack\",\n    \"loan_status\", \"credit_score_brack\",\n    \"loan_status\", \"person_education\",\n    \"loan_status\", \"previous_loan_defaults_on_file\",\n    \"loan_status\", \"loan_percent_income_brack\",\n    \"loan_status\", \"person_income_brack\",\n    \"loan_status\", \"loan_amnt_brack\",\n    \"loan_status\", \"person_home_ownership\",\n    \"loan_status\", \"loan_int_rate_brack\",\n    \"loan_status\", \"loan_intent\",\n\n    \"person_age_brack\", \"person_gender\",\n    \"credit_score_brack\", \"person_gender\",\n    \"person_education\", \"person_gender\",\n    \"previous_loan_defaults_on_file\", \"person_gender\",\n    \"loan_percent_income_brack\", \"person_gender\",\n    \"person_income_brack\", \"person_gender\",\n    \"loan_amnt_brack\", \"person_gender\",\n    \"person_home_ownership\", \"person_gender\",\n    \"loan_int_rate_brack\", \"person_gender\",\n    \"loan_intent\", \"person_gender\",\n    \"person_gender\", \"person_age_brack\",\n    \"credit_score_brack\", \"person_age_brack\",\n    \"person_education\", \"person_age_brack\",\n    \"previous_loan_defaults_on_file\", \"person_age_brack\",\n    \"loan_percent_income_brack\", \"person_age_brack\",\n    \"person_income_brack\", \"person_age_brack\",\n    \"loan_amnt_brack\", \"person_age_brack\",\n    \"person_home_ownership\", \"person_age_brack\",\n    \"loan_int_rate_brack\", \"person_age_brack\",\n    \"loan_intent\", \"person_age_brack\",\n    \"person_age_brack\", \"person_education\",\n    \"person_gender\", \"person_education\",\n    \"credit_score_brack\", \"person_education\",\n    \"previous_loan_defaults_on_file\", \"person_education\",\n    \"loan_percent_income_brack\", \"person_education\",\n    \"person_income_brack\", \"person_education\",\n    \"loan_amnt_brack\", \"person_education\",\n    \"person_home_ownership\", \"person_education\",\n    \"loan_int_rate_brack\", \"person_education\",\n    \"loan_intent\", \"person_education\"\n  ),\n  ncol = 2,\n  byrow = TRUE,\n  dimnames = list(\n    NULL,\n    c(\"from\", \"to\")\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nhc_bn <- hc(\n  loan_train,\n  blacklist = bl\n  )\n\ngraphviz.plot(hc_bn)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nmmhc_bn <- mmhc(\n  loan_train,\n  blacklist = bl\n  )\n\ngraphviz.plot(mmhc_bn)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\niamb_bn <- iamb(\n  loan_train,\n  blacklist = bl\n  )\n\ngraphviz.plot(iamb_bn)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nFrom the DAGs, apparently gender is not that important of a node in our model. We can also see that when using the Incremental Association (IAMB) algorithm that some of the edges between nodes are not directional. We will have to do some extra work by setting the arcs between the non-directional edges a certain way. This takes some domain knowledge to see what makes the most sense. This is where creating a bayes net becomes more art than science. Below are the decisions that were made to complete the DAG. \n\nThe DAG needs to be fully directional so that network scores can be computed. \n\n\n::: {.cell}\n\n```{.r .cell-code}\narcs(iamb_dag) <- arcs(iamb_bn)\n\niamb_dag <- set.arc(iamb_dag, from = \"loan_int_rate_brack\", to = \"loan_intent\")\niamb_dag <- set.arc(iamb_dag, from = \"loan_percent_income_brack\", to = \"loan_amnt_brack\")\n\niamb_dag <- set.arc(iamb_dag, from = \"loan_percent_income_brack\", to = \"person_income_brack\")\niamb_dag <- set.arc(iamb_dag, from = \"loan_amnt_brack\", to = \"person_income_brack\")\n\ngraphviz.plot(iamb_dag)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\narcs(hc_dag) <- hc_bn$arcs\narcs(mmhc_dag) <- mmhc_bn$arcs\n```\n:::\n\n\n## Domain Knowledge DAG\n\nThe final DAG I created was something that I thought of without any structural learning. This uses demographic variables as the starting nodes and then setting arcs that made sense to me. This defined DAG will also be compared to the learned DAGs to see what model has the lowest log likelihood and BDE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narcs <- matrix(\n  c(\n    \"person_gender\", \"person_income_brack\",\n    \"person_gender\", \"person_home_ownership\",\n    \"person_gender\", \"previous_loan_defaults_on_file\",\n\n    \"person_age_brack\", \"person_income_brack\",\n    \"person_age_brack\", \"person_home_ownership\",\n    \"person_age_brack\", \"previous_loan_defaults_on_file\",\n\n    \"person_education\", \"person_income_brack\",\n    \"person_education\", \"person_home_ownership\",\n    \"person_education\", \"previous_loan_defaults_on_file\",\n\n    \"person_income_brack\", \"credit_score_brack\", \n    \"person_home_ownership\", \"credit_score_brack\", \n    \"previous_loan_defaults_on_file\", \"credit_score_brack\",\n\n    \"person_income_brack\", \"loan_percent_income_brack\",\n    \"person_home_ownership\", \"loan_percent_income_brack\",\n\n    \"person_gender\", \"loan_int_rate_brack\",\n    \"person_education\", \"loan_int_rate_brack\",\n    \"person_age_brack\", \"loan_int_rate_brack\",\n    \"person_income_brack\", \"loan_int_rate_brack\",\n    \"person_home_ownership\", \"loan_int_rate_brack\",\n    \"previous_loan_defaults_on_file\", \"loan_int_rate_brack\",\n\n    \"person_income_brack\", \"loan_amnt_brack\",\n    \"person_home_ownership\", \"loan_amnt_brack\",\n\n    \"loan_percent_income_brack\", \"loan_intent\",\n    \"loan_int_rate_brack\", \"loan_intent\",\n    \"loan_amnt_brack\", \"loan_intent\",\n    \"credit_score_brack\", \"loan_intent\",\n\n    \"loan_int_rate_brack\", \"loan_status\",\n    \"credit_score_brack\", \"loan_status\",\n    \"loan_percent_income_brack\", \"loan_status\",\n    \"loan_amnt_brack\", \"loan_status\",\n    \"previous_loan_defaults_on_file\", \"loan_status\",\n    \"loan_intent\", \"loan_status\"\n    ),\n  byrow = TRUE,\n  ncol = 2,\n  dimnames = list(NULL, c(\"from\", \"to\"))\n)\n\narcs(jp_dag) <- arcs\n\ngraphviz.plot(jp_dag)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmap(\n  list(\n    dag,\n    jp_dag,\n    hc_dag,\n    mmhc_dag,\n    iamb_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"loglik\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -429780\n\n[[2]]\n[1] -410700.2\n\n[[3]]\n[1] -386319.3\n\n[[4]]\n[1] -389004.6\n\n[[5]]\n[1] -387806\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    dag,\n    jp_dag,\n    hc_dag,\n    mmhc_dag,\n    iamb_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"aic\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -429813\n\n[[2]]\n[1] -418042.2\n\n[[3]]\n[1] -386717.3\n\n[[4]]\n[1] -389278.6\n\n[[5]]\n[1] -389074\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    dag,\n    jp_dag,\n    hc_dag,\n    mmhc_dag,\n    iamb_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"bic\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -429952\n\n[[2]]\n[1] -448967.2\n\n[[3]]\n[1] -388393.7\n\n[[4]]\n[1] -390432.7\n\n[[5]]\n[1] -394414.8\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    dag,\n    jp_dag,\n    hc_dag,\n    mmhc_dag,\n    iamb_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"bde\", iss = 5)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -429941\n\n[[2]]\n[1] -430616.4\n\n[[3]]\n[1] -387687.8\n\n[[4]]\n[1] -389857.5\n\n[[5]]\n[1] -393009.6\n```\n\n\n:::\n:::\n\n\nAfter calculating all of the scores, it seems like the DAG created from the Hill Climb algorithm is the best fitting model, so I am going to fit that DAG for the model. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nhc_fit <- bn.fit(hc_dag, data = loan_train, method = \"bayes\", iss = 5)\n```\n:::\n\n\nWhile this model used the training data, I'm still interested in looking at the likelihood of being accepted for a loan and the probabilities of getting a a low interest rate based on the loan amount, home ownership, and if the person has defaulted on a previous loan.\n\nI printed out the DAG again to make it easier to see what nodes I am particularly interested in. I also included the `str()` function to see the breakdown of the table of probabilities when using bnlearn. \n\nLooking at the output, the table is broken down into the first index showing the levels of loan status (1 = \"0\"/\"Decline\", 2 = \"1\"/\"Accepted\"), the second index showing the levels of the loan amount as a percentage of annual income variable, and so on following the values of the list. For the conditional probabilities printed for the model (`hc_fit$loan_status$prob[2, 1:4, 1:3, 1:3, 1:2]`), I am only interested in looking at the combinations of each parent node for those that are accepted for a loan. \n\nIt seems that not having a previous default on file leads to a higher probability of being accepted for a loan, which makes sense.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngraphviz.plot(hc_dag)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n\n```{.r .cell-code}\nhc_fit$loan_status$prob |> str()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 'table' num [1:2, 1:4, 1:3, 1:3, 1:2] 0.908 0.092 0.888 0.112 0.858 ...\n - attr(*, \"dimnames\")=List of 5\n  ..$ loan_status                   : chr [1:2] \"0\" \"1\"\n  ..$ loan_percent_income_brack     : chr [1:4] \"0-.09\" \".1 - .19\" \".2 - .29\" \".3+\"\n  ..$ loan_int_rate_brack           : chr [1:3] \"<10\" \"10 - 15\" \"15+\"\n  ..$ person_home_ownership         : chr [1:3] \"MORTGAGE\" \"OWN\" \"RENT\"\n  ..$ previous_loan_defaults_on_file: chr [1:2] \"No\" \"Yes\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# loan status - yes\nhc_fit$loan_status$prob[2, 1:4, 1:3, 1:3, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , person_home_ownership = MORTGAGE, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.09204538045 0.23441689989 0.68234908528\n                 .1 - .19 0.11181890282 0.27953722168 0.69203251344\n                 .2 - .29 0.14229782194 0.35013823128 0.82235274788\n                 .3+      0.25833519803 0.50364778600 0.79207013871\n\n, , person_home_ownership = OWN, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00036142836 0.00025706941 0.37554019015\n                 .1 - .19 0.13415540959 0.17275431782 0.31612550164\n                 .2 - .29 0.29006635834 0.28331900258 0.40937696665\n                 .3+      0.43912749408 0.31612550164 0.62445980985\n\n, , person_home_ownership = RENT, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.14568259065 0.34125578284 0.85128541940\n                 .1 - .19 0.20362270164 0.39789409908 0.85317350774\n                 .2 - .29 0.70486047665 0.77799227799 0.93997469113\n                 .3+      0.99989151660 0.99995745188 0.99980609633\n\n, , person_home_ownership = MORTGAGE, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00001960523 0.00002052057 0.00025148375\n                 .1 - .19 0.00002556734 0.00002182320 0.00023934897\n                 .2 - .29 0.00010091632 0.00006323831 0.00044476072\n                 .3+      0.00037713079 0.00020416497 0.00246791708\n\n, , person_home_ownership = OWN, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00018761726 0.00015706477 0.00099009901\n                 .1 - .19 0.00018561140 0.00012266326 0.00072233459\n                 .2 - .29 0.00032129546 0.00022984279 0.00133191263\n                 .3+      0.00070761393 0.00057803468 0.00491159136\n\n, , person_home_ownership = RENT, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00003029679 0.00001976144 0.00025706941\n                 .1 - .19 0.00002644355 0.00001597107 0.00019282684\n                 .2 - .29 0.00010616162 0.00005181884 0.00075369310\n                 .3+      0.50000000000 0.50000000000 0.50000000000\n```\n\n\n:::\n:::\n\n\nAnother node I was interested in was the interest rate levels. Below I show the probability of each interest rate level. Interesting that the probability of getting an interest rate between 10% and 15% seemed similar if the person has or has not defaulted on a previous loan. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# loan interest rates\n# < 10 percent interest rate\nhc_fit$loan_int_rate_brack$prob[1, 1:5, 1:3, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , previous_loan_defaults_on_file = No\n\n               person_home_ownership\nloan_amnt_brack  MORTGAGE       OWN      RENT\n   <5k          0.4319922 0.3372990 0.2485702\n   5k - 9.99k   0.4289390 0.4413874 0.2817689\n   10k - 14.99k 0.3818242 0.3749606 0.2521690\n   15k - 19.99k 0.2261606 0.2045198 0.1497653\n   20k+         0.1632122 0.1856410 0.1316751\n\n, , previous_loan_defaults_on_file = Yes\n\n               person_home_ownership\nloan_amnt_brack  MORTGAGE       OWN      RENT\n   <5k          0.4996333 0.4057123 0.3626205\n   5k - 9.99k   0.5184934 0.4311780 0.4009119\n   10k - 14.99k 0.4553838 0.3736940 0.3217806\n   15k - 19.99k 0.3118322 0.3258567 0.2633289\n   20k+         0.2222483 0.2171009 0.1872255\n```\n\n\n:::\n\n```{.r .cell-code}\n# 10-15 percent interest rate\nhc_fit$loan_int_rate_brack$prob[2, 1:5, 1:3, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , previous_loan_defaults_on_file = No\n\n               person_home_ownership\nloan_amnt_brack  MORTGAGE       OWN      RENT\n   <5k          0.4828632 0.5792025 0.6103174\n   5k - 9.99k   0.4720931 0.4653994 0.5596162\n   10k - 14.99k 0.4904833 0.5168716 0.5987237\n   15k - 19.99k 0.6113127 0.6723164 0.6480722\n   20k+         0.5282189 0.5364103 0.5793884\n\n, , previous_loan_defaults_on_file = Yes\n\n               person_home_ownership\nloan_amnt_brack  MORTGAGE       OWN      RENT\n   <5k          0.4669755 0.5270534 0.5972150\n   5k - 9.99k   0.4503999 0.4948113 0.5578687\n   10k - 14.99k 0.5006534 0.5205381 0.6228410\n   15k - 19.99k 0.6224036 0.6062305 0.6886723\n   20k+         0.6525271 0.6379426 0.6686627\n```\n\n\n:::\n\n```{.r .cell-code}\n# 15+ percent interest rate\nhc_fit$loan_int_rate_brack$prob[3, 1:5, 1:3, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , previous_loan_defaults_on_file = No\n\n               person_home_ownership\nloan_amnt_brack   MORTGAGE        OWN       RENT\n   <5k          0.08514465 0.08349857 0.14111240\n   5k - 9.99k   0.09896793 0.09321327 0.15861494\n   10k - 14.99k 0.12769256 0.10816777 0.14910728\n   15k - 19.99k 0.16252675 0.12316384 0.20216242\n   20k+         0.30856886 0.27794872 0.28893644\n\n, , previous_loan_defaults_on_file = Yes\n\n               person_home_ownership\nloan_amnt_brack   MORTGAGE        OWN       RENT\n   <5k          0.03339124 0.06723434 0.04016452\n   5k - 9.99k   0.03110673 0.07401072 0.04121932\n   10k - 14.99k 0.04396282 0.10576785 0.05537834\n   15k - 19.99k 0.06576415 0.06791277 0.04799882\n   20k+         0.12522459 0.14495658 0.14411178\n```\n\n\n:::\n:::\n\n\n## Cross Validation\n\nI also wanted to include the code for cross validation. You can either conduct cross validation with the data and start with a structure learning algorithm or you can include the DAG that was created and then make predictions. Here, since I am using the DAG I created with the training dataset, it will separate the data into a training and validation datasets. I am going to focus on the reduction of the classification error. I am also going to use the parent nodes to predict whether people get approved for loans and have 10 folds. I also checked to see the confusion matrix and see the proportions of true and false positives and true and false negatives. Overall, it seems like the model is doing okay with false positives and false negatives. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set.seed(12345)\n# hc_cv_fit <- bn.cv(\n#   loan_train, \n#   bn = \"hc\", \n#   algorithm.args = list(\n#     blacklist = bl\n#     ),\n#   loss = \"pred\",\n#   loss.args = list(\n#     predict = \"parents\",\n#     target = \"loan_status\"\n#     ),\n#   runs = 10\n#   )\n\nset.seed(12345)\nhc_cv_fit <- bn.cv(\n  data = loan_train,\n  hc_dag,\n  loss = \"pred\",\n  loss.args = list(\n    predict = \"parents\",\n    target = \"loan_status\"\n    ),\n  runs = 10\n)\n\n# hc_cv_fit[[1]][[1]] |> str()\n\nhc_cv_fit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  k-fold cross-validation for Bayesian networks\n\n  target network structure:\n   [loan_percent_income_brack][person_age_brack][person_gender]\n   [person_education][credit_score_brack|person_age_brack:person_education]\n   [person_income_brack|loan_percent_income_brack]\n   [loan_amnt_brack|loan_percent_income_brack:person_income_brack]\n   [person_home_ownership|person_income_brack]\n   [previous_loan_defaults_on_file|credit_score_brack:loan_percent_income_brack:person_home_ownership]\n   [loan_int_rate_brack|loan_amnt_brack:person_home_ownership:previous_loan_defaults_on_file]\n   [loan_intent|person_home_ownership:previous_loan_defaults_on_file]\n   [loan_status|loan_percent_income_brack:loan_int_rate_brack:person_home_ownership:previous_loan_defaults_on_file]\n  number of folds:                       10 \n  loss function:                         Classification Error \n  training node:                         loan_status \n  number of runs:                        10 \n  average loss over the runs:            0.1106233 \n  standard deviation of the loss:        0.0001862066 \n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  1:10,\n  ~round(\n  prop.table(\n    table(\n      hc_cv_fit[[.x]][[1]]$observed,\n      hc_cv_fit[[.x]][[1]]$predicted\n    )\n  ),\n  2\n)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n   \n       0    1\n  0 0.74 0.03\n  1 0.08 0.15\n\n[[2]]\n   \n       0    1\n  0 0.75 0.02\n  1 0.09 0.13\n\n[[3]]\n   \n       0    1\n  0 0.76 0.03\n  1 0.09 0.13\n\n[[4]]\n   \n       0    1\n  0 0.76 0.03\n  1 0.08 0.13\n\n[[5]]\n   \n       0    1\n  0 0.75 0.03\n  1 0.09 0.14\n\n[[6]]\n   \n       0    1\n  0 0.76 0.02\n  1 0.08 0.14\n\n[[7]]\n   \n       0    1\n  0 0.74 0.03\n  1 0.09 0.14\n\n[[8]]\n   \n       0    1\n  0 0.74 0.03\n  1 0.08 0.15\n\n[[9]]\n   \n       0    1\n  0 0.74 0.02\n  1 0.09 0.14\n\n[[10]]\n   \n       0    1\n  0 0.75 0.03\n  1 0.09 0.14\n```\n\n\n:::\n:::\n\n\nThe last thing I'll do when working with the training data and the original DAG is to predict if a person is approved for a loan based on likelihood weighting. Predicting can be done by using the parents, similar to what was done for the cross validation, but the bayes-lw method is often a better method. It does take longer to run the code though. I'm using the training set to be able to compare the confusion matrix for this model and the updated model with additonal arcs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use predict to infer the target variable on the test set\nset.seed(12345)\nhc_pred <- predict(\n  hc_fit,\n  node = \"loan_status\",\n  data = loan_train,\n  method = \"bayes-lw\" # \"parents\"\n  )\n\nround(\n  prop.table(\n    table(\n      loan_train$loan_status,\n      hc_pred\n    )\n  ),\n  2\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   hc_pred\n       0    1\n  0 0.75 0.03\n  1 0.08 0.14\n```\n\n\n:::\n:::\n\n\nI decided to try and include the gender node and made a small change to include an edge between credit score and home ownership. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nhc_up_dag <- hc_dag\n\nhc_up_dag <- set.arc(hc_up_dag, from = \"person_gender\", to = \"credit_score_brack\")\nhc_up_dag <- set.arc(hc_up_dag, from = \"credit_score_brack\", to = \"person_home_ownership\")\n\ngraphviz.plot(hc_up_dag)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\nFirst, I'll check the network scores between the two models. Overall, it does not seem like much has changed but the updated model has a negligible improvement so I decided to use that model.    \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap(\n  list(\n    hc_dag,\n    hc_up_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"loglik\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -386319.3\n\n[[2]]\n[1] -386286.4\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    hc_dag,\n    hc_up_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"aic\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -386717.3\n\n[[2]]\n[1] -386784.4\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    hc_dag,\n    hc_up_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"bic\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -388393.7\n\n[[2]]\n[1] -388882\n```\n\n\n:::\n\n```{.r .cell-code}\nmap(\n  list(\n    hc_dag,\n    hc_up_dag\n  ),\n  ~bn_score(.x, loan_train, type = \"bde\", iss = 5000, prior = \"vsp\")\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] -406968.7\n\n[[2]]\n[1] -406442.9\n```\n\n\n:::\n:::\n\n\nLooking at the confusion matrix, nothing has changed so I'll now just move on to using the testing dataset. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nhc_up_fit <- bn.fit(hc_up_dag, data = loan_train, method = \"bayes\", iss = 5)\n\nset.seed(12345)\nhc_up_predict <- predict(\n  hc_up_fit,\n  node = \"loan_status\",\n  data = loan_train,\n  method = \"bayes-lw\" # \"parents\"\n  )\n\nround(\n  prop.table(\n    table(\n      loan_train$loan_status,\n      hc_up_predict\n    )\n  ),\n  2\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   hc_up_predict\n       0    1\n  0 0.75 0.03\n  1 0.08 0.14\n```\n\n\n:::\n:::\n\n\n# Test Data\n\nWhen using the test data, the confusion matrix mimics the output from the training data. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use predict to infer the target variable on the test set\nset.seed(12345)\nhc_predict <- predict(\n  hc_up_fit,\n  node = \"loan_status\",\n  data = loan_test,\n  method = \"bayes-lw\" # \"parents\"\n  )\n\nround(\n  prop.table(\n    table(\n      loan_test$loan_status,\n      hc_predict\n    )\n  ),\n  2\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   hc_predict\n       0    1\n  0 0.74 0.03\n  1 0.09 0.14\n```\n\n\n:::\n:::\n\n\nI also decided to calculate the accuracy in addition to the classification error. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nincorrect_pred <- sum(hc_predict != loan_test$loan_status)  # Count mismatched predictions\ncorrect_pred <- sum(hc_predict == loan_test$loan_status)\ntotal_pred <- length(hc_predict)  # Total number of predictions\n\n# Classification Error\nce <- incorrect_pred/total_pred\n\n# Accuracy\nacc <- correct_pred/total_pred\n```\n:::\n\n\nThe accuracy is the opposite of the classification error, but I included the code for both. The accuracy for the model was 0.88 and the classification error was 0.12. \n\nI also included the conditional probabilities for `loan_status`. The interesting finding from the updated model is that when a person has defaulted on a previous loan, none of the other nodes matter and the probability of getting approved for a loan is zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhc_up_fit$loan_status$prob[2, 1:4, 1:3, 1:3, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n, , person_home_ownership = MORTGAGE, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.09204538045 0.23441689989 0.68234908528\n                 .1 - .19 0.11181890282 0.27953722168 0.69203251344\n                 .2 - .29 0.14229782194 0.35013823128 0.82235274788\n                 .3+      0.25833519803 0.50364778600 0.79207013871\n\n, , person_home_ownership = OWN, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00036142836 0.00025706941 0.37554019015\n                 .1 - .19 0.13415540959 0.17275431782 0.31612550164\n                 .2 - .29 0.29006635834 0.28331900258 0.40937696665\n                 .3+      0.43912749408 0.31612550164 0.62445980985\n\n, , person_home_ownership = RENT, previous_loan_defaults_on_file = No\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.14568259065 0.34125578284 0.85128541940\n                 .1 - .19 0.20362270164 0.39789409908 0.85317350774\n                 .2 - .29 0.70486047665 0.77799227799 0.93997469113\n                 .3+      0.99989151660 0.99995745188 0.99980609633\n\n, , person_home_ownership = MORTGAGE, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00001960523 0.00002052057 0.00025148375\n                 .1 - .19 0.00002556734 0.00002182320 0.00023934897\n                 .2 - .29 0.00010091632 0.00006323831 0.00044476072\n                 .3+      0.00037713079 0.00020416497 0.00246791708\n\n, , person_home_ownership = OWN, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00018761726 0.00015706477 0.00099009901\n                 .1 - .19 0.00018561140 0.00012266326 0.00072233459\n                 .2 - .29 0.00032129546 0.00022984279 0.00133191263\n                 .3+      0.00070761393 0.00057803468 0.00491159136\n\n, , person_home_ownership = RENT, previous_loan_defaults_on_file = Yes\n\n                         loan_int_rate_brack\nloan_percent_income_brack           <10       10 - 15           15+\n                 0-.09    0.00003029679 0.00001976144 0.00025706941\n                 .1 - .19 0.00002644355 0.00001597107 0.00019282684\n                 .2 - .29 0.00010616162 0.00005181884 0.00075369310\n                 .3+      0.50000000000 0.50000000000 0.50000000000\n```\n\n\n:::\n:::\n\n\nA major feature that I like about using bnlearn is the `cpquery()` function. This function takes the bayes net model that was created to estimate an event that occurred from any amount of evidence we provide.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndr_loan <- cpquery(\n  hc_up_fit,\n  event = (\n    loan_status == \"1\"\n    ),\n  evidence = (\n    person_education == \"Doctorate\"\n  )\n)\n\ncomplex_loan <- cpquery(\n  hc_up_fit,\n  event = (\n    loan_status == \"1\"\n  ),\n  evidence = (\n    (person_home_ownership == \"RENT\") &\n    (loan_intent == \"DEBTCONSOLIDATION\") &\n    (loan_int_rate_brack == \"10 - 15\") |\n    (loan_int_rate_brack == \"15+\") &\n    (previous_loan_defaults_on_file == \"No\") &\n    (person_education %in% c(\"Bachelor\", \"Master\", \"Doctor\"))\n  )\n)\n```\n:::\n\n\nFor example, we can see that the probability of a person getting a loan approved when their education is a doctorate is about 25.84%.\n\nWe can look at more complex queries. For instance, we can see what the likelihood of getting approved for a loan when someone is renting, looking for a loan for debt consolidation, okay with an interest rate of either 10-15% or 15+%, has never defaulted on a previous loan, and either has a bachelors, masters, or doctorate degree. With all of the evidence provided, the probability of getting approved for the loan is 51.6%. ",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}